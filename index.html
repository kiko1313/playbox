<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayBox | Premium Streaming</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS VARIABLES & THEME CONFIGURATION --- */
        :root {
            /* Palette: Raspberry to Violet */
            --color-raspberry: #D72638;
            --color-raspberry-dark: #a81b2a;
            --color-violet: #7B2CBF;
            --color-violet-light: #9D4EDD;

            /* Neutrals */
            --bg-dark: #0f0f13;
            --bg-card: #1a1a20;
            --bg-panel: #25252e;
            --text-main: #ffffff;
            --text-muted: #a0a0b0;
            --border-color: rgba(255, 255, 255, 0.1);

            /* Gradients & Effects */
            --gradient-primary: linear-gradient(135deg, var(--color-raspberry) 0%, var(--color-violet) 100%);
            --gradient-hover: linear-gradient(135deg, var(--color-raspberry-dark) 0%, var(--color-violet-light) 100%);
            --glow-shadow: 0 4px 30px rgba(215, 38, 56, 0.3);
            --glass-bg: rgba(26, 26, 32, 0.7);

            /* Spacing & Radius */
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --container-width: 1400px;
        }

        /* --- RESET & BASE --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        a {
            text-decoration: none;
            color: inherit;
            transition: 0.3s;
        }

        ul {
            list-style: none;
        }

        img {
            max-width: 100%;
            display: block;
            object-fit: cover;
        }

        button {
            cursor: pointer;
            border: none;
            font-family: inherit;
        }

        /* --- UTILITIES --- */
        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
        }

        .grid {
            display: grid;
        }

        .items-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .text-gradient {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* --- LAYOUT --- */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* --- NAVIGATION --- */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: rgba(15, 15, 19, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .brand i {
            color: var(--color-raspberry);
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
        }

        .btn-nav {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            padding: 0.5rem 1.2rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .btn-nav:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--glow-shadow);
            font-weight: 600;
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(215, 38, 56, 0.5);
            transform: scale(1.05);
        }

        /* --- VISITOR PAGE LAYOUT --- */
        .visitor-layout {
            display: flex;
            padding-top: 70px;
            /* Offset fixed header */
            min-height: 100vh;
        }

        /* Sidebar (Files & Links) */
        .sidebar {
            width: 300px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-color);
            height: calc(100vh - 70px);
            position: fixed;
            left: 0;
            top: 70px;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        .sidebar-section h3 {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-link-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 0.8rem;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-link-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--color-violet);
            transform: translateX(5px);
        }

        .file-link-icon {
            width: 36px;
            height: 36px;
            background: rgba(123, 44, 191, 0.2);
            color: var(--color-violet-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }

        .file-link-info h4 {
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .file-link-info span {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Main Content (Videos) */
        .main-content {
            flex: 1;
            margin-left: 300px;
            /* Sidebar width */
            padding: 2rem;
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.3), rgba(15, 15, 19, 1)), url('https://picsum.photos/seed/cinema/1600/600') no-repeat center/cover;
            height: 400px;
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 3rem;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(215, 38, 56, 0.2), transparent 60%);
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 600px;
        }

        .hero h1 {
            font-size: 3.5rem;
            line-height: 1.1;
            margin-bottom: 1rem;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        .hero p {
            font-size: 1.1rem;
            color: #ddd;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        /* Video Grid */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .video-card {
            background: transparent;
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: transform 0.3s ease;
            cursor: pointer;
            group: video-card;
        }

        .video-card:hover {
            transform: translateY(-5px);
        }

        .thumbnail-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            /* 16:9 Aspect Ratio */
            background: #000;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 0.8rem;
            border: 1px solid var(--border-color);
        }

        .thumbnail-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .video-card:hover .thumbnail-img {
            transform: scale(1.05);
        }

        .play-icon-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 50px;
            height: 50px;
            background: rgba(215, 38, 56, 0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(215, 38, 56, 0.5);
        }

        .video-card:hover .play-icon-overlay {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .video-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-meta {
            font-size: 0.85rem;
            color: var(--text-muted);
            display: flex;
            gap: 10px;
        }

        /* --- VIDEO PLAYER PAGE --- */
        .player-container {
            display: flex;
            gap: 2rem;
            padding: 2rem;
            margin-left: 0;
            /* Override visitor margin for full experience */
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .player-wrapper {
            flex: 2.5;
        }

        .video-frame {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--radius-lg);
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .video-frame iframe,
        .video-frame video {
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-details {
            margin-top: 1.5rem;
        }

        .video-details h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .video-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .player-sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* --- LOGIN & ADMIN --- */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f13 100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 2000;
        }

        .login-card {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: white;
            transition: 0.3s;
        }

        .form-input:focus {
            border-color: var(--color-raspberry);
            box-shadow: 0 0 0 3px rgba(215, 38, 56, 0.2);
        }

        /* Admin Dashboard */
        .admin-dashboard {
            padding: 3rem 2rem;
            margin-left: 0;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .admin-menu {
            background: var(--bg-panel);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            height: fit-content;
        }

        .admin-menu button {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 1rem;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            text-align: left;
        }

        .admin-menu button.active,
        .admin-menu button:hover {
            background: var(--gradient-primary);
            color: white;
        }

        .admin-content {
            background: var(--bg-panel);
            padding: 2rem;
            border-radius: var(--radius-md);
            min-height: 500px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th,
        .data-table td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .btn-delete {
            background: rgba(255, 59, 48, 0.15);
            color: #ff3b30;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .btn-delete:hover {
            background: #ff3b30;
            color: white;
        }

        /* --- TOAST NOTIFICATIONS --- */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-card);
            border-left: 4px solid var(--color-raspberry);
            padding: 1rem 1.5rem;
            border-radius: var(--radius-sm);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            min-width: 300px;
        }

        .toast.success {
            border-color: #2ecc71;
        }

        .toast.error {
            border-color: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .player-container {
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2.5rem;
            }

            .navbar {
                padding: 0 1rem;
            }

            .brand span {
                display: none;
            }

            /* Hide text on small mobile, keep icon */
            .brand i {
                display: block;
                font-size: 1.5rem;
            }

            .video-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- --- NAVIGATION --- -->
    <nav class="navbar">
        <div class="brand">
            <i class="fas fa-play-circle fa-lg"></i>
            <span>PlayBox</span>
        </div>
        <div class="nav-actions">
            <!-- MONETAG AD SLOT: Top Bar Banner -->
            <div id="monetag-topbar" style="display:none;"></div>

            <button class="btn-nav hidden" id="homeBtn" onclick="router('visitor')">
                <i class="fas fa-home"></i> Home
            </button>
            <button class="btn-nav" id="adminBtn" onclick="router('login')">
                <i class="fas fa-user-shield"></i> Admin
            </button>
            <button class="btn-nav btn-primary hidden" id="logoutBtn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </nav>

    <!-- --- APP CONTAINER --- -->
    <div id="app" class="app-container">
        <!-- Content Injected via JS -->
    </div>

    <!-- --- TOAST CONTAINER --- -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- --- JAVASCRIPT --- -->
    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            currentUser: null, // null, 'admin'
            currentPage: 'visitor', // 'visitor', 'player', 'login', 'admin'
            activeVideo: null,
            data: {
                videos: [],
                files: [],
                smartLinkUrl: '' // Global Smart Link URL
            }
        };

        // --- MOCK DATA INITIALIZATION ---
        function initData() {
            const storedData = localStorage.getItem('playboxData');
            if (storedData) {
                state.data = JSON.parse(storedData);
                // Schema Migration for existing data
                if (!state.data.smartLinkUrl) state.data.smartLinkUrl = '';
            } else {
                // Default Data
                state.data = {
                    videos: [
                        { id: 1, title: 'Cinematic Travel: Japan 4K', type: 'youtube', src: 'https://www.youtube.com/watch?v=LXb3EKWsInQ', views: '1.2M', date: '2 days ago' },
                        { id: 2, title: 'Relaxing Lo-Fi Beats to Study To', type: 'youtube', src: 'https://www.youtube.com/watch?v=jfKfPfyJRdk', views: '850K', date: '1 week ago' },
                        { id: 3, title: 'Modern Architecture Design Ideas', type: 'youtube', src: 'https://www.youtube.com/watch?v=qE0o1kDfYpQ', views: '45K', date: '3 days ago' },
                        { id: 4, title: 'Nature Documentary: Ocean Life', type: 'youtube', src: 'https://www.youtube.com/watch?v=6v2L2UGZJAM', views: '2.5M', date: '1 month ago' }
                    ],
                    files: [
                        { id: 1, title: 'VLC Media Player', type: 'link', url: 'https://www.videolan.org/vlc/', desc: 'Best open source video player' },
                        { id: 2, title: 'Adobe Premiere Pro', type: 'link', url: '#', desc: 'Professional video editing software' },
                        { id: 3, title: 'PlayBox Guide.pdf', type: 'file', url: '#', desc: 'User manual for the platform' }
                    ],
                    smartLinkUrl: '' // Default empty
                };
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('playboxData', JSON.stringify(state.data));
        }

        // --- UTILS ---
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- SMART LINK HANDLER ---
        function openSmartLink(targetUrl) {
            const adUrl = state.data.smartLinkUrl;
            // Cooldown in milliseconds (e.g., 30 minutes = 30 * 60 * 1000)
            const AD_COOLDOWN = 30 * 60 * 1000;
            const lastClick = localStorage.getItem('playbox_last_ad_click');
            const now = Date.now();

            if (adUrl && adUrl.startsWith('http')) {
                // Check if we are within the cooldown period
                if (!lastClick || (now - parseInt(lastClick)) > AD_COOLDOWN) {
                    // Time to show the ad
                    window.open(adUrl, '_blank');
                    localStorage.setItem('playbox_last_ad_click', now.toString()); // Update timestamp

                    // Open Content in Current Tab (or new tab if preferred) after a slight delay
                    setTimeout(() => {
                        window.open(targetUrl, '_blank');
                    }, 100);
                } else {
                    // In cooldown period, just open content directly
                    window.open(targetUrl, '_blank');
                }
            } else {
                // No Ad Configured, just open content
                window.open(targetUrl, '_blank');
            }
        }

        // --- ROUTING & RENDERING ---
        function router(page, payload = null) {
            state.currentPage = page;
            const app = document.getElementById('app');

            // Update Navbar Buttons based on auth
            const adminBtn = document.getElementById('adminBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const homeBtn = document.getElementById('homeBtn');

            if (state.currentUser === 'admin') {
                adminBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                homeBtn.classList.remove('hidden');
                if (page === 'login') page = 'admin';
            } else {
                adminBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                homeBtn.classList.add('hidden');
            }

            app.innerHTML = ''; // Clear current view

            switch (page) {
                case 'visitor': renderVisitor(app); break;
                case 'player': renderPlayer(app, payload); break;
                case 'login': renderLogin(app); break;
                case 'admin': renderAdmin(app); break;
            }

            // Re-inject Monetag Ad Slots (Simulated)
            // In a real scenario, you would call the ad loader function here.
        }

        // --- HELPER: THUMBNAIL GENERATOR ---
        function getThumbnailHtml(video) {
            const youtubeId = getYouTubeID(video.src);

            if (youtubeId) {
                // YouTube Thumbnail
                return `
                    <img src="https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg" class="thumbnail-img" alt="${video.title}" onerror="this.src='https://picsum.photos/seed/${video.id}/400/225'">
                    <div class="play-icon-overlay"><i class="fas fa-play"></i></div>
                `;
            } else {
                // Direct Video File (URL)
                // Use a generic placeholder or the video itself if possible without breaking layout
                // Falling back to a safe placeholder to ensure no "empty boxes"
                return `
                    <img src="https://picsum.photos/seed/${video.id}/400/225" class="thumbnail-img" alt="${video.title}">
                    <div class="play-icon-overlay"><i class="fas fa-play"></i></div>
                `;
            }
        }

        // --- VIEW: VISITOR PAGE ---
        function renderVisitor(container) {
            const layout = document.createElement('div');
            layout.className = 'visitor-layout';

            // Sidebar
            const sidebar = document.createElement('aside');
            sidebar.className = 'sidebar';

            // Generate File/Links List
            let fileListHtml = state.data.files.map(file => `
                <div class="file-link-card">
                    <div class="file-link-icon" onclick="openSmartLink('${file.url}')">
                        <i class="fas ${file.type === 'file' ? 'fa-file-download' : 'fa-external-link-alt'}"></i>
                    </div>
                    <div class="file-link-info" onclick="openSmartLink('${file.url}')" style="flex:1;">
                        <h4>${file.title}</h4>
                        <span>${file.desc}</span>
                    </div>
                    <button class="btn-nav" style="padding: 0.3rem 0.8rem; font-size: 0.8rem; background: rgba(255,255,255,0.1);" onclick="openSmartLink('${file.url}')">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            `).join('');

            sidebar.innerHTML = `
                <div class="sidebar-section">
                    <h3><i class="fas fa-folder-open"></i> Files & Links</h3>
                    <div style="margin-bottom: 1rem; padding: 10px; background: rgba(215,38,56,0.1); border-radius: 8px; font-size: 0.8rem; color: var(--color-raspberry);">
                        Download premium tools and visit our partners.
                    </div>
                    ${fileListHtml || '<p style="color:var(--text-muted)">No files added yet.</p>'}
                </div>
                <!-- MONETAG AD SLOT: Sidebar Rect -->
                <div id="monetag-sidebar" style="min-height: 250px; background: rgba(255,255,255,0.05); border-radius: 8px; display:flex; align-items:center; justify-content:center; color: var(--text-muted);">
                    AD SPACE
                </div>
            `;

            // Main Content
            const main = document.createElement('main');
            main.className = 'main-content';

            // Generate Video Grid
            let videoGridHtml = state.data.videos.map(video => `
                <div class="video-card" onclick="openVideo(${video.id})">
                    <div class="thumbnail-container">
                        ${getThumbnailHtml(video)}
                    </div>
                    <div class="video-info">
                        <h3>${video.title}</h3>
                        <div class="video-meta">
                            <span>${video.views} views</span>
                            <span>•</span>
                            <span>${video.date}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            main.innerHTML = `
                <section class="hero">
                    <div class="hero-content">
                        <span style="background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 1rem; display: inline-block;">New Release</span>
                        <h1>Unlimited Streaming, <span class="text-gradient">Zero Limits.</span></h1>
                        <p>Experience the best content curated for you. High quality, fast streaming, and exclusive downloads available in our hub.</p>
                        <button class="btn-nav btn-primary" onclick="document.querySelector('.video-grid').scrollIntoView({behavior: 'smooth'})">
                            Start Watching
                        </button>
                    </div>
                </section>
                
                <div class="section-header">
                    <h2>Trending Now</h2>
                    <!-- MONETAG AD SLOT: Small Banner -->
                </div>

                <div class="video-grid">
                    ${videoGridHtml}
                </div>
            `;

            layout.appendChild(sidebar);
            layout.appendChild(main);
            container.appendChild(layout);
        }

        // --- VIEW: PLAYER PAGE ---
        function openVideo(id) {
            const video = state.data.videos.find(v => v.id === id);
            if (video) router('player', video);
        }

        function renderPlayer(container, video) {
            container.style.marginLeft = '0'; // Full width
            container.style.paddingTop = '70px';

            let playerHtml = '';

            // Check if it's a direct file link (mp4/webm) or YouTube
            const isDirectFile = video.src.match(/\.(mp4|webm|ogg)$/i);

            if (video.type === 'youtube' || (!isDirectFile && (video.src.includes('youtube') || video.src.includes('youtu.be')))) {
                const videoId = getYouTubeID(video.src);
                if (videoId) {
                    // Removed complex parameters (origin, referrer) to fix local/file protocol playback issues
                    // Using standard embed format which is most robust for local testing
                    playerHtml = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                } else {
                    playerHtml = `
                        <div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#ff3b30; text-align:center; padding:1rem;">
                            <i class="fas fa-exclamation-triangle fa-3x" style="margin-bottom:1rem;"></i>
                            <h3>Invalid Video URL</h3>
                            <p>Could not extract ID from: ${video.src}</p>
                            <p style="font-size:0.8rem; margin-top:0.5rem; color:#ccc;">Please use a standard YouTube link (e.g., youtube.com/watch?v=... or youtube.com/shorts/...)</p>
                        </div>
                    `;
                }
            } else {
                // Direct File
                playerHtml = `<video src="${video.src}" controls autoplay controlsList="nodownload"></video>`;
            }

            const layout = document.createElement('div');
            layout.className = 'player-container';

            layout.innerHTML = `
                <div class="player-wrapper">
                    <div class="video-frame">
                        ${playerHtml}
                    </div>
                    <div class="video-details">
                        <h1>${video.title}</h1>
                        <div class="video-meta" style="margin: 0.5rem 0 1rem 0;">
                            ${video.views} views • ${video.date}
                            <span style="display:inline-block; margin-left:15px; font-family:monospace; background:#333; padding:2px 6px; border-radius:4px; font-size:0.75rem; color:#aaa;">ID: ${video.type === 'youtube' || video.src.includes('youtu') ? (getYouTubeID(video.src) || 'N/A') : 'Local'}</span>
                        </div>
                        <div class="video-actions">
                            <button class="btn-nav"><i class="fas fa-thumbs-up"></i> Like</button>
                            <button class="btn-nav"><i class="fas fa-share"></i> Share</button>
                            <button class="btn-nav" onclick="router('visitor')"><i class="fas fa-arrow-left"></i> Back to Browse</button>
                        </div>
                        <p style="margin-top: 1rem; color: #ccc; line-height: 1.6;">
                            This is a premium viewing experience on PlayBox. Enjoy high-quality streaming without interruptions. 
                            Don't forget to check the sidebar for useful tools and links.
                        </p>
                    </div>
                    <!-- MONETAG AD SLOT: Under Video -->
                    <div id="monetag-videounder" style="margin-top: 2rem; height: 90px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center;">AD BANNER SPACE</div>
                </div>

                <div class="player-sidebar">
                    <div class="sidebar-section">
                        <h3>Up Next</h3>
                        ${state.data.videos.filter(v => v.id !== video.id).slice(0, 5).map(v => `
                            <div class="file-link-card" onclick="openVideo(${v.id})">
                                <div style="width: 120px; height: 68px; border-radius: 6px; overflow: hidden; position: relative;">
                                    ${getThumbnailHtml(v)}
                                </div>
                                <div class="file-link-info">
                                    <h4 style="font-size: 0.9rem;">${v.title}</h4>
                                    <span>${v.views}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.appendChild(layout);
        }

        // --- VIEW: LOGIN ---
        function renderLogin(container) {
            const wrapper = document.createElement('div');
            wrapper.className = 'auth-container';
            wrapper.innerHTML = `
                <div class="login-card">
                    <div class="brand" style="justify-content: center; margin-bottom: 2rem;">
                        <i class="fas fa-play-circle fa-2x"></i>
                        <span style="font-size: 2rem;">PlayBox</span>
                    </div>
                    <h2 style="margin-bottom: 0.5rem;">Admin Access</h2>
                    <p style="color: var(--text-muted); margin-bottom: 2rem;">Sign in to manage content</p>
                    
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="username" class="form-input" placeholder="Enter username" required>
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="password" class="form-input" placeholder="Enter password" required>
                        </div>
                        <button type="submit" class="btn-nav btn-primary" style="width: 100%; justify-content: center;">Login</button>
                    </form>
                    <button onclick="router('visitor')" style="margin-top: 1rem; background: none; color: var(--text-muted); width: 100%;">Back to Home</button>
                </div>
            `;
            container.appendChild(wrapper);
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            if (u === 'admin' && p === 'cristal') {
                state.currentUser = 'admin';
                showToast('Welcome back, Admin!');
                router('admin');
            } else {
                showToast('Invalid credentials', 'error');
            }
        }

        function logout() {
            state.currentUser = null;
            showToast('Logged out successfully');
            router('visitor');
        }

        // --- VIEW: ADMIN DASHBOARD ---
        function renderAdmin(container) {
            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'admin-dashboard';

            wrapper.innerHTML = `
                <h1 style="margin-bottom: 2rem;">Admin Dashboard</h1>
                <div class="dashboard-grid">
                    <aside class="admin-menu">
                        <button class="active" onclick="switchAdminTab('videos', this)"><i class="fas fa-video"></i> Manage Videos</button>
                        <button onclick="switchAdminTab('files', this)"><i class="fas fa-folder"></i> Manage Files & Links</button>
                        <button onclick="switchAdminTab('ads', this)"><i class="fas fa-dollar-sign"></i> Smart Link Settings</button>
                    </aside>
                    
                    <main class="admin-content" id="adminPanelContent">
                        <!-- Content injected here -->
                    </main>
                </div>
            `;
            container.appendChild(wrapper);
            renderAdminVideos(); // Default tab
        }

        function switchAdminTab(tab, btn) {
            // Update UI
            document.querySelectorAll('.admin-menu button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (tab === 'videos') renderAdminVideos();
            if (tab === 'files') renderAdminFiles();
            if (tab === 'ads') renderAdminAds();
        }

        // --- ADMIN: VIDEO MANAGER ---
        function renderAdminVideos() {
            const content = document.getElementById('adminPanelContent');

            const list = state.data.videos.map(v => `
                <tr>
                    <td>${v.title}</td>
                    <td>${v.type}</td>
                    <td>${v.views}</td>
                    <td>
                        <button class="btn-delete" onclick="deleteVideo(${v.id})"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('');

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Video Library</h2>
                </div>
                
                <!-- Upload Form -->
                <div style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: var(--radius-sm); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Add New Video</h3>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" id="vidTitle" class="form-input" placeholder="Video Title">
                        <select id="vidType" class="form-input">
                            <option value="youtube">YouTube URL</option>
                            <option value="url">Direct Video Link (MP4/WebM)</option>
                        </select>
                    </div>
                    <div style="margin-top: 1rem;">
                        <input type="text" id="vidUrl" class="form-input" placeholder="Paste YouTube Link or Video URL here...">
                    </div>
                    <button class="btn-nav btn-primary" style="margin-top: 1rem;" onclick="uploadVideo()">Add Video</button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Views</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${list || '<tr><td colspan="4" style="text-align:center">No videos found.</td></tr>'}</tbody>
                </table>
            `;
        }

        function toggleVideoInput() {
            // Deprecated function - logic removed for simplicity as PC upload is gone
        }

        function uploadVideo() {
            const title = document.getElementById('vidTitle').value;
            const type = document.getElementById('vidType').value;
            const url = document.getElementById('vidUrl').value;

            if (!title) return showToast('Please enter a title', 'error');
            if (!url) return showToast('Please enter the URL', 'error');

            const newVideo = {
                id: Date.now(),
                title: title,
                type: type,
                src: url,
                views: '0',
                date: 'Just now'
            };

            state.data.videos.unshift(newVideo);
            saveData();
            showToast('Video added successfully');
            renderAdminVideos(); // Refresh list
        }

        function deleteVideo(id) {
            if (confirm('Are you sure you want to delete this video?')) {
                state.data.videos = state.data.videos.filter(v => v.id !== id);
                saveData();
                showToast('Video deleted');
                renderAdminVideos();
            }
        }

        // --- ADMIN: FILES MANAGER ---
        function renderAdminFiles() {
            const content = document.getElementById('adminPanelContent');

            const list = state.data.files.map(f => `
                <tr>
                    <td>${f.title}</td>
                    <td>${f.type.toUpperCase()}</td>
                    <td>${f.desc}</td>
                    <td>
                        <button class="btn-delete" onclick="deleteFile(${f.id})"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                </tr>
            `).join('');

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Files & Links</h2>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: var(--radius-sm); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Add File / Link</h3>
                    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="text" id="fileTitle" class="form-input" placeholder="Title (e.g. Photoshop)">
                        <select id="fileType" class="form-input">
                            <option value="link">External Link</option>
                            <option value="file">Downloadable File (URL)</option>
                        </select>
                    </div>
                    <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1rem; margin-top: 1rem;">
                        <input type="text" id="fileUrl" class="form-input" placeholder="URL (https://...)">
                        <input type="text" id="fileDesc" class="form-input" placeholder="Short Desc">
                    </div>
                    <button class="btn-nav btn-primary" style="margin-top: 1rem;" onclick="uploadFile()">Add Resource</button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${list || '<tr><td colspan="4" style="text-align:center">No resources found.</td></tr>'}</tbody>
                </table>
            `;
        }

        function toggleFileInput() {
            // Deprecated
        }

        function uploadFile() {
            const title = document.getElementById('fileTitle').value;
            const typeInput = document.getElementById('fileType').value;
            const desc = document.getElementById('fileDesc').value;
            const url = document.getElementById('fileUrl').value;

            if (!title) return showToast('Please fill in title', 'error');
            if (!url) return showToast('Please fill in url', 'error');

            const newFile = {
                id: Date.now(),
                title, type: typeInput, url, desc
            };

            state.data.files.unshift(newFile);
            saveData();
            showToast('Resource added successfully');
            renderAdminFiles();
        }

        function deleteFile(id) {
            if (confirm('Delete this resource?')) {
                state.data.files = state.data.files.filter(f => f.id !== id);
                saveData();
                showToast('Resource deleted');
                renderAdminFiles();
            }
        }

        // --- ADMIN: ADS SETTINGS ---
        function renderAdminAds() {
            const content = document.getElementById('adminPanelContent');

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Monetization Settings</h2>
                </div>
                
                <div style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: var(--radius-sm); margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Smart Link Configuration</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                        This link will open in a new tab whenever a user clicks on a File or Download button.
                    </p>
                    <div class="form-group">
                        <label>Monetag Smart Link / Direct Link URL</label>
                        <input type="text" id="smartLinkUrl" class="form-input" placeholder="https://..." value="${state.data.smartLinkUrl || ''}">
                    </div>
                    <button class="btn-nav btn-primary" onclick="saveSmartLink()">Save Settings</button>
                </div>
            `;
        }

        function saveSmartLink() {
            const url = document.getElementById('smartLinkUrl').value;
            state.data.smartLinkUrl = url;
            saveData();
            showToast('Smart Link URL updated!');
        }

        // --- HELPER: YOUTUBE ID EXTRACTOR (Architect Grade) ---
        function getYouTubeID(url) {
            if (!url) return null;
            try {
                // Handle standard full URLs with URL API
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    const urlObj = new URL(url.startsWith('http') ? url : `https://${url}`);

                    // Case 1: Shorts (youtube.com/shorts/ID)
                    if (urlObj.pathname.includes('/shorts/')) {
                        const parts = urlObj.pathname.split('/');
                        return parts[parts.indexOf('shorts') + 1] || null;
                    }

                    // Case 2: Live (youtube.com/live/ID)
                    if (urlObj.pathname.includes('/live/')) {
                        const parts = urlObj.pathname.split('/');
                        return parts[parts.indexOf('live') + 1] || null;
                    }

                    // Case 3: Standard watch (youtube.com/watch?v=ID)
                    if (urlObj.searchParams.has('v')) {
                        return urlObj.searchParams.get('v');
                    }

                    // Case 4: Shortened (youtu.be/ID)
                    if (urlObj.hostname === 'youtu.be') {
                        return urlObj.pathname.slice(1); // remove leading slash
                    }

                    // Case 5: Embed (youtube.com/embed/ID)
                    if (urlObj.pathname.includes('/embed/')) {
                        const parts = urlObj.pathname.split('/');
                        return parts[parts.indexOf('embed') + 1] || null;
                    }
                }
            } catch (e) {
                // Fallback for partial/malformed URLs
                // Regex for Standard, Shorts, Live, Shortened, and Embeds
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/|live\/)([^#&?\/]*).*/;
                const match = url.match(regExp);
                return (match && match[2] && match[2].length >= 10) ? match[2] : null;
            }
            return null;
        }

        // --- HELPER: THUMBNAIL GENERATOR (Premium) ---
        function getThumbnailHtml(video) {
            const youtubeId = getYouTubeID(video.src);

            if (youtubeId) {
                // YouTube: High Resolution Thumbnail
                return `
                    <div class="video-preview-wrapper" style="position:relative; width:100%; height:100%;">
                        <img src="https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg" 
                             class="thumbnail-img" 
                             alt="${video.title}" 
                             onerror="this.src='https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg'"> <!-- Fallback to HQ if maxres (404) fails -->
                        <div class="play-icon-overlay"><i class="fas fa-play"></i></div>
                    </div>
                `;
            } else {
                // Direct File: Live Preview
                // We render a muted video tag that plays on hover
                return `
                    <div class="video-preview-wrapper" style="position:relative; width:100%; height:100%; background:#000;">
                        <video 
                            src="${video.src}#t=0.1" 
                            class="thumbnail-img" 
                            muted 
                            playsinline 
                            loop 
                            preload="metadata"
                            style="object-fit:cover; width:100%; height:100%;"
                            onmouseover="this.play()" 
                            onmouseout="this.pause(); this.currentTime=0.1;"
                        ></video>
                        <div class="play-icon-overlay"><i class="fas fa-play"></i></div>
                    </div>
                `;
            }
        }

        // --- GLOBAL YOUTUBE API SETUP ---
        let player; // Global player instance
        function onYouTubeIframeAPIReady() {
            console.log('YouTube API Ready');
        }

        // --- VIEW: PLAYER PAGE (Architect Version) ---
        function openVideo(id) {
            const video = state.data.videos.find(v => v.id === id);
            if (video) router('player', video);
        }

        function renderPlayer(container, video) {
            container.style.marginLeft = '0'; // Full width
            container.style.paddingTop = '70px';

            const layout = document.createElement('div');
            layout.className = 'player-container';
            layout.innerHTML = `
                <div class="player-wrapper">
                    <div class="video-frame">
                        <div id="video-player-target"></div>
                    </div>
                    <div class="video-details">
                        <h1>${video.title}</h1>
                        <div class="video-meta" style="margin: 0.5rem 0 1rem 0;">
                            ${video.views} views • ${video.date}
                            <span id="player-status-badge" style="display:none; margin-left:15px; font-family:monospace; background:#333; padding:2px 6px; border-radius:4px; font-size:0.75rem; color:#aaa;">Initializing...</span>
                        </div>
                        <div class="video-actions">
                            <button class="btn-nav"><i class="fas fa-thumbs-up"></i> Like</button>
                            <button class="btn-nav"><i class="fas fa-share"></i> Share</button>
                            <button class="btn-nav" onclick="router('visitor')"><i class="fas fa-arrow-left"></i> Back to Browse</button>
                        </div>
                        <p style="margin-top: 1rem; color: #ccc; line-height: 1.6;">
                            This is a premium viewing experience on PlayBox. Enjoy high-quality streaming without interruptions. 
                        </p>
                    </div>
                    <!-- MONETAG AD SLOT: Under Video -->
                    <div id="monetag-videounder" style="margin-top: 2rem; height: 90px; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center;">AD BANNER SPACE</div>
                </div>

                <div class="player-sidebar">
                    <div class="sidebar-section">
                        <h3>Up Next</h3>
                        ${state.data.videos.filter(v => v.id !== video.id).slice(0, 5).map(v => `
                            <div class="file-link-card" onclick="openVideo(${v.id})">
                                <div style="width: 120px; height: 68px; border-radius: 6px; overflow: hidden; position: relative;">
                                    ${getThumbnailHtml(v)}
                                </div>
                                <div class="file-link-info">
                                    <h4 style="font-size: 0.9rem;">${v.title}</h4>
                                    <span>${v.views}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.appendChild(layout);

            // --- PLAYER INITIALIZATION LOGIC ---
            const videoId = getYouTubeID(video.src);
            const isYouTube = !!videoId;
            const target = document.getElementById('video-player-target');
            const statusBadge = document.getElementById('player-status-badge');

            if (isYouTube) {
                // Initialize YouTube Player
                statusBadge.style.display = 'inline-block';
                statusBadge.textContent = 'Loading API... ' + videoId;

                // Ensure API is loaded
                if (!window.YT) {
                    const tag = document.createElement('script');
                    tag.src = "https://www.youtube.com/iframe_api";
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                    // Wait for it
                    window.onYouTubeIframeAPIReady = () => {
                        createYTPlayer(videoId);
                    };
                } else {
                    createYTPlayer(videoId);
                }
            } else {
                // Direct Video File
                target.innerHTML = `<video src="${video.src}" controls autoplay style="width:100%; height:100%; border-radius: inherit;"></video>`;
            }

            function createYTPlayer(id) {
                statusBadge.textContent = 'Player Ready: ' + id;
                try {
                    player = new YT.Player('video-player-target', {
                        height: '100%',
                        width: '100%',
                        videoId: id,
                        playerVars: {
                            'playsinline': 1,
                            'autoplay': 1,
                            'rel': 0
                        },
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange,
                            'onError': onPlayerError
                        }
                    });
                } catch (e) {
                    statusBadge.textContent = 'API Error: ' + e.message;
                    showToast('Critical Player Error', 'error');
                }
            }

            function onPlayerReady(event) {
                event.target.playVideo();
                statusBadge.style.color = '#2ecc71'; // Green
                statusBadge.textContent = 'Playing: ' + videoId;
            }

            function onPlayerStateChange(event) {
                // -1 (unstarted), 0 (ended), 1 (playing), 2 (paused), 3 (buffering), 5 (video cued)
                if (event.data == yt.PlayerState.PLAYING) {
                    // Ad logic could go here
                }
            }

            function onPlayerError(event) {
                const errorMap = {
                    2: 'Invalid Parameter',
                    5: 'HTML5 Error',
                    100: 'Video Not Found (Removed/Private)',
                    101: 'Playback Not Allowed (Embedded Disabled)',
                    150: 'Playback Not Allowed (Embedded Disabled)'
                };
                const msg = errorMap[event.data] || 'Unknown Error';
                statusBadge.style.color = '#e74c3c'; // Red
                statusBadge.textContent = 'Error: ' + msg;

                // Show user friendly UI
                document.getElementById('video-player-target').innerHTML = `
                    <div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#ff3b30; text-align:center; padding:1rem;">
                        <i class="fas fa-exclamation-circle fa-3x" style="margin-bottom:1rem;"></i>
                        <h3>Playback Error</h3>
                        <p>${msg}</p>
                        <p style="font-size:0.8rem; margin-top:0.5rem; color:#ccc;">ID: ${videoId}</p>
                    </div>
                `;
            }
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            initData();
            router('visitor');

            // --- MONETAG SERVICE WORKER ---
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registered', reg))
                    .catch(err => console.error('Service Worker failed', err));
            }
        });


    </script>
</body>

</html>